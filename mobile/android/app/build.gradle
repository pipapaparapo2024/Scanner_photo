apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

/**
 * This is the configuration block to customize your React Native Android app.
 * By default you don't need to apply any configuration, just uncomment the lines you need.
 */
react {
    hermesEnabled = true
}

/**
 * Set this to true to Run Proguard on Release builds to minify the Java bytecode.
 */
def enableProguardInReleaseBuilds = false

/**
 * The preferred build flavor of JavaScriptCore (JSC)
 *
 * For example, to use the international variant, you can use:
 * `def jscFlavor = 'org.webkit:android-jsc-intl:+'`
 *
 * The international variant includes ICU i18n library and necessary data
 * allowing to use e.g. `Date.toLocaleString` and `String.localeCompare` that
 * give correct results when using with locales other than en-US. Note that
 * this variant is about 6MiB larger per architecture than default.
 */
def jscFlavor = 'org.webkit:android-jsc:+'

android {
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace "com.scanimg"
    defaultConfig {
        applicationId "com.scanimg"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"
        testBuildType System.getProperty("testBuildType", "debug")
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        
        // ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ React Native
        // SENTRY_DSN Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· gradle.properties Ð¸Ð»Ð¸ local.properties
        // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð² gradle.properties: SENTRY_DSN=https://your-dsn@sentry.io/project-id
        def sentryDsn = project.findProperty('SENTRY_DSN') ?: ''
        buildConfigField "String", "SENTRY_DSN", "\"${sentryDsn}\""
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    
    kotlinOptions {
        jvmTarget = "17"
        freeCompilerArgs += ["-Xskip-metadata-version-check"]
    }
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        release {
            // Ð’ CI/CD ÑÑ‚Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· -P Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
            if (project.hasProperty('android.injected.signing.store.file')) {
                storeFile file(project.property('android.injected.signing.store.file'))
                storePassword project.property('android.injected.signing.store.password')
                keyAlias project.property('android.injected.signing.key.alias')
                keyPassword project.property('android.injected.signing.key.password')
            } else {
                // Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ debug keystore
                // Ð’ production Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° release keystore
                storeFile file('debug.keystore')
                storePassword 'android'
                keyAlias 'androiddebugkey'
                keyPassword 'android'
            }
        }
    }
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            signingConfig signingConfigs.release
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
            proguardFile "${rootProject.projectDir}/../node_modules/detox/android/detox/proguard-rules-app.pro"
        }
    }
}

// ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹
task uninstallOldApp(type: Exec) {
    group = 'install'
    description = 'Ð£Ð´Ð°Ð»ÑÐµÑ‚ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹'
    ignoreExitValue = true
    
    if (System.getProperty('os.name').toLowerCase().contains('windows')) {
        commandLine 'cmd', '/c', 'adb', 'uninstall', 'com.scanimg'
    } else {
        commandLine 'adb', 'uninstall', 'com.scanimg'
    }
    
    doFirst {
        println 'ðŸ§¹ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ...'
    }
    
    doLast {
        println 'âœ… Ð¡Ñ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾ (ÐµÑÐ»Ð¸ Ð±Ñ‹Ð»Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾)'
    }
}

// ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÐµÑˆÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
task clearAppCache(type: Exec) {
    group = 'install'
    description = 'ÐžÑ‡Ð¸Ñ‰Ð°ÐµÑ‚ ÐºÐµÑˆ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ'
    ignoreExitValue = true
    
    if (System.getProperty('os.name').toLowerCase().contains('windows')) {
        commandLine 'cmd', '/c', 'adb', 'shell', 'pm', 'clear', 'com.scanimg'
    } else {
        commandLine 'adb', 'shell', 'pm', 'clear', 'com.scanimg'
    }
    
    doLast {
        println 'âœ… ÐšÐµÑˆ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½'
    }
}

// Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ .webp Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿ÐµÑ€ÐµÐ´ ÑÐ±Ð¾Ñ€ÐºÐ¾Ð¹
task deleteWebpIcons(type: Delete) {
    def resDir = file("src/main/res")
    if (resDir.exists()) {
        resDir.eachDir { dir ->
            dir.eachFileMatch(~/.*\.webp$/) { file ->
                delete file
                println "Ð£Ð´Ð°Ð»ÐµÐ½ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚: ${file.path}"
            }
        }
    }
}

// Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ ÑÐ»Ð¸ÑÐ½Ð¸ÐµÐ¼ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
afterEvaluate {
    tasks.matching { it.name.startsWith("merge") && it.name.contains("Resources") }.configureEach {
        dependsOn deleteWebpIcons
    }
    preBuild.dependsOn deleteWebpIcons
    
    // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹
    tasks.matching { it.name == "installDebug" || it.name == "installRelease" }.configureEach { installTask ->
        installTask.dependsOn uninstallOldApp
        installTask.dependsOn clearAppCache
    }
}

dependencies {
    // The version of react-native is set by the React Native Gradle Plugin
    implementation("com.facebook.react:react-android:0.73.6")
    implementation("com.facebook.react:flipper-integration:0.73.6")
    implementation libs.core.ktx
    implementation libs.appcompat
    implementation libs.material
    testImplementation libs.junit
    androidTestImplementation("com.wix:detox:+")
    androidTestImplementation libs.ext.junit
    androidTestImplementation libs.espresso.core

    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android:0.73.6")
    } else {
        implementation jscFlavor
    }
    
    // Explicitly add pdfbox-android to help resolution
    implementation 'com.github.TomRoush:PdfBox-Android:v1.8.9.1'
}

apply from: file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesAppBuildGradle(project)
apply plugin: "com.google.gms.google-services"
