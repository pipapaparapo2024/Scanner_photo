# Unit-тесты для ScanImg Backend

## Структура тестов

```
src/__tests__/
├── services/
│   ├── scanService.test.ts      # Тесты для сервиса сканирования
│   ├── userService.test.ts       # Тесты для сервиса пользователей
│   ├── adService.test.ts         # Тесты для сервиса рекламы
│   └── iapService.test.ts        # Тесты для сервиса покупок
└── utils/
    ├── dateUtils.test.ts         # Тесты для утилит дат
    └── textUtils.test.ts         # Тесты для утилит текста
```

## Запуск тестов

```bash
# Запустить все тесты
npm test

# Запустить тесты в watch режиме
npm run test:watch

# Запустить тесты с покрытием
npm run test:coverage
```

## Покрытие

Цель покрытия: **60-70%** для критичных модулей:
- `scanService.ts` - создание сканов, валидация
- `userService.ts` - создание пользователей, авторизация
- `adService.ts` - начисление токенов за рекламу
- `iapService.ts` - валидация покупок

## Что тестируется

### ScanService
- ✅ Создание скана при наличии токенов
- ✅ Ошибка при отсутствии токенов
- ✅ Нормализация кириллицы
- ✅ Обработка пустого текста
- ✅ Пагинация списка сканов
- ✅ Обновление комментария
- ✅ Удаление скана

### UserService
- ✅ Получение существующего пользователя
- ✅ Обработка несуществующего пользователя
- ✅ Обновление токенов до начального значения
- ✅ Создание пользователя с хешированием пароля
- ✅ Обновление существующего пользователя

### AdService
- ✅ Создание токена для рекламы (только при 0 токенов)
- ✅ Ошибка при наличии токенов
- ✅ Начисление 3 токенов за просмотр рекламы
- ✅ Валидация токена

### IapService
- ✅ Начисление 50 токенов за пакет
- ✅ Начисление 100 токенов за пакет
- ✅ Ошибка для неизвестного продукта
- ✅ Пропуск проверки RuStore если не настроено
- ✅ Проверка через RuStore API если настроено

### Utils
- ✅ Нормализация Unicode (кириллица)
- ✅ Валидация текста
- ✅ Форматирование дат
- ✅ Группировка по датам

## Моки

Все внешние зависимости мокируются:
- Firebase/Firestore
- Репозитории
- HTTP запросы (axios)
- bcrypt

## CI/CD

Тесты можно интегрировать в CI/CD пайплайн:
```yaml
# Пример для GitHub Actions
- name: Run tests
  run: npm test
- name: Check coverage
  run: npm run test:coverage
```
